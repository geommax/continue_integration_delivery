name: Create Release

on:
  push:
    tags:
      - 'release-v*.*.*'
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., 1.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  FRONTEND_IMAGE: growth-calculator-web
  API_IMAGE: api-gateway-python

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # fetch full history and tags so git tag listing works reliably
          fetch-depth: 0


      - name: Detect latest container versions (git tags only)
        id: detect_versions
        run: |
          set -e

          # Ensure tags are present in the runner (in case checkout was shallow)
          git fetch --tags --prune origin || true

          # Find latest git tags matching the expected naming convention
          FRONTEND_TAG=$(git tag -l "frontend-v*.*.*" | sort -V | tail -1 || true)
          API_TAG=$(git tag -l "api-v*.*.*" | sort -V | tail -1 || true)

          if [ -z "$FRONTEND_TAG" ]; then
            echo "::error::No git tag matching 'frontend-v*.*.*' found. Create a tag like 'frontend-v1.2.3'." && exit 1
          fi
          if [ -z "$API_TAG" ]; then
            echo "::error::No git tag matching 'api-v*.*.*' found. Create a tag like 'api-v1.2.3'." && exit 1
          fi

          FRONTEND_VERSION="${FRONTEND_TAG#frontend-v}"
          API_VERSION="${API_TAG#api-v}"

          echo "frontend_version=$FRONTEND_VERSION" >> $GITHUB_OUTPUT
          echo "api_version=$API_VERSION" >> $GITHUB_OUTPUT
          echo "Detected frontend: $FRONTEND_VERSION, api: $API_VERSION"

      - name: Generate release notes
        run: |
          FRONTEND_VERSION="${{ steps.detect_versions.outputs.frontend_version }}"
          API_VERSION="${{ steps.detect_versions.outputs.api_version }}"
          RELEASE_VERSION="${{ inputs.release_version }}"
          cat > release_notes.md << EOF
          ## ðŸŽ‰ Growth Calculator Release v$RELEASE_VERSION

          ### ðŸ“¦ Docker Images

          This release includes the following container versions:

          #### Frontend
          \`\`\`bash
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:$FRONTEND_VERSION
          \`\`\`

          #### API Gateway
          \`\`\`bash
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.API_IMAGE }}:$API_VERSION
          \`\`\`

          ### ðŸ“Œ Version Information

          | Component | Version |
          |-----------|---------|
          | **Frontend** | \`$FRONTEND_VERSION\` |
          | **API Gateway** | \`$API_VERSION\` |
          | **MongoDB** | \`7.0\` |

          ---

          ## ðŸš€ Complete Deployment

          ### Prerequisites
          \`\`\`bash
          # Create network
          docker network create growth-calculator-network

          # Start MongoDB
          sudo docker run -d \\
            --name growth-calculator-mongodb \\
            --network growth-calculator-network \\
            -p 27017:27017 \\
            -v \$(pwd)/mongodb/data:/data/db \\
            -e TZ=Asia/Yangon \\
            mongo:7.0
          \`\`\`

          ### Full Stack Deployment

          \`\`\`bash
          #!/bin/bash
          FRONTEND_VERSION="$FRONTEND_VERSION"
          API_VERSION="$API_VERSION"
          
          FRONTEND_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:\$FRONTEND_VERSION"
          API_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.API_IMAGE }}:\$API_VERSION"

          echo "ðŸ”„ Deploying Growth Calculator v$RELEASE_VERSION..."

          # Stop existing containers
          sudo docker stop growth-calculator-api growth-calculator-web 2>/dev/null
          sudo docker rm growth-calculator-api growth-calculator-web 2>/dev/null

          # Pull images
          echo "Pulling images..."
          docker pull \$API_IMAGE
          docker pull \$FRONTEND_IMAGE

          # Start API Gateway
          echo "Starting API Gateway..."
          sudo docker run -d \\
            --name growth-calculator-api \\
            --network growth-calculator-network \\
            -p 8080:8080 \\
            -e MONGO_URL=mongodb://growth-calculator-mongodb:27017/ \\
            -e TZ=Asia/Yangon \\
            \$API_IMAGE

          # Wait for API
          echo "Waiting for API..."
          sleep 5

          # Start Frontend
          echo "Starting Frontend..."
          sudo docker run -d \\
            --name growth-calculator-web \\
            --network growth-calculator-network \\
            -p 3001:80 \\
            -e TZ=Asia/Yangon \\
            \$FRONTEND_IMAGE

          # Verify
          echo ""
          echo "âœ… Deployment complete!"
          sudo docker ps | grep growth-calculator
          
          echo ""
          echo "Health Checks:"
          sleep 3
          curl -f http://localhost:8080/health && echo "âœ… API is healthy"
          curl -f http://localhost:3001 && echo "âœ… Frontend is healthy"
          
          echo ""
          echo "ðŸŽ¯ Application ready at: http://localhost:3001"
          \`\`\`

          ### Docker Compose

          Save as \`docker-compose.yml\`:
          \`\`\`yaml
          version: '3.8'

          services:
            mongodb:
              image: mongo:7.0
              container_name: growth-calculator-mongodb
              ports:
                - "27017:27017"
              volumes:
                - ./mongodb/data:/data/db
              environment:
                - TZ=Asia/Yangon
              networks:
                - growth-calculator-network

            api-gateway:
              image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.API_IMAGE }}:$API_VERSION
              container_name: growth-calculator-api
              ports:
                - "8080:8080"
              environment:
                - MONGO_URL=mongodb://growth-calculator-mongodb:27017/
                - TZ=Asia/Yangon
              depends_on:
                - mongodb
              networks:
                - growth-calculator-network

            frontend:
              image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:$FRONTEND_VERSION
              container_name: growth-calculator-web
              ports:
                - "3001:80"
              environment:
                - TZ=Asia/Yangon
              depends_on:
                - api-gateway
              networks:
                - growth-calculator-network

          networks:
            growth-calculator-network:
              driver: bridge
          \`\`\`

          Deploy:
          \`\`\`bash
          docker-compose up -d
          \`\`\`

          ---

          ## ðŸ“‹ Individual Container Updates

          ### Update Frontend Only
          \`\`\`bash
          sudo docker stop growth-calculator-web
          sudo docker rm growth-calculator-web
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:$FRONTEND_VERSION
          sudo docker run -d \\
            --name growth-calculator-web \\
            --network growth-calculator-network \\
            -p 3001:80 \\
            -e TZ=Asia/Yangon \\
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:$FRONTEND_VERSION
          \`\`\`

          ### Update API Only
          \`\`\`bash
          sudo docker stop growth-calculator-api
          sudo docker rm growth-calculator-api
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.API_IMAGE }}:$API_VERSION
          sudo docker run -d \\
            --name growth-calculator-api \\
            --network growth-calculator-network \\
            -p 8080:8080 \\
            -e MONGO_URL=mongodb://growth-calculator-mongodb:27017/ \\
            -e TZ=Asia/Yangon \\
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.API_IMAGE }}:$API_VERSION
          \`\`\`

          ---

          ## âœ… Verification

          \`\`\`bash
          # Check running containers
          sudo docker ps | grep growth-calculator

          # Test API health
          curl http://localhost:8080/health

          # Test Frontend
          curl http://localhost:3001

          # Check API documentation
          open http://localhost:8080/docs

          # View logs
          sudo docker logs growth-calculator-api
          sudo docker logs growth-calculator-web
          sudo docker logs growth-calculator-mongodb
          \`\`\`

          ---

          ## ðŸ”„ Rollback

          To rollback to a previous version, use the deployment script with the old version numbers.

          ---

          ## ðŸ“š Documentation

          - [Release Guide](https://github.com/${{ github.repository }}/blob/main/RELEASE-GUIDE.md)
          - [System Architecture](https://github.com/${{ github.repository }}/blob/main/ARCHITECTURE.md)
          - [API Documentation](http://localhost:8080/docs)

          ---

          ## ðŸ”— Container Images

          - Frontend: [\`${{ secrets.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:$FRONTEND_VERSION\`](https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE }})
          - API Gateway: [\`${{ secrets.DOCKERHUB_USERNAME }}/${{ env.API_IMAGE }}:$API_VERSION\`](https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.API_IMAGE }})
          EOF
          
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.release_version }}
          name: Release v${{ inputs.release_version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output summary
        run: |
          FRONTEND_VERSION="${{ steps.detect_versions.outputs.frontend_version }}"
          API_VERSION="${{ steps.detect_versions.outputs.api_version }}"
          echo "### âœ… Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Version:** v${{ inputs.release_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Version:** $FRONTEND_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**API Gateway Version:** $API_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.release_version }})" >> $GITHUB_STEP_SUMMARY
